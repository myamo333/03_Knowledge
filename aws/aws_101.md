# AWS (Amazon Web Services)
- Amazon社が提供するクラウドサービス
- 100以上のサービスが存在し、クラウドサービスとして世界最大規模
- 世界No1.シェアであり、Micosoftが提供する「Azure」が続く
<br>

## AWSの特徴
  - サービスが豊富
    - EC2やRDSなど、100以上のサービスが存在
    - 高負荷に耐えられる、信頼性の高いシステムをうくない手間で運用できる
  - リソースが柔軟
    - リソースを、必要なときに必要な分だけ調達できる
  - 従量課金
    - 使った文だけ支払う従量課金モデル
    - 不必要なときは使う必要がなく、費用対効果に優れている

## IAMとは？
- IAMとはAWSのサービスの「認証」と「認可」の設定を行うことができるサービス
- AWSアカウントを作成するとルートユーザーが作成される
- ルートユーザーは普段は使用せず、作業用のIAMユーザーを使用するのがベストプラクティス
<br>

- ルートユーザー
  - アカウントのすべてのAWSサービスとAWSリソースに完全なアクセス権を持つ特権ユーザー
  - アカウントの変更・解約、サポートプランの変更等をする時のみ使用する
  - 極力ルートユーザーを使用しない！
- 作業用ユーザー(IAMユーザー)
  - AWSで作成するユーザ
  - 認証情報とアクセス許可の権限を個別に変更できる
  - 作業者事に個別に作成する
  - 通常の作業はIAMユーザーで行う！
<br>

## AWSのネットワーク
### リージョン (Resion)
- AWSの各サービスが提供されている地域のこと
- まず、このリージョンを設定し、サーバーを構築する
- リージョンごとに利用できるサービスが異なる。アメリカが最先端
- ただし、日本で設定したほうが応答性良くなる
- Tokyo：`ap-northeast-1a`
<br>

### アベイラビリティゾーン
- 独立したデータセンター
- 一つのアベイラビリティゾーンが潰れても、別のアベイラビリティゾーンでサービスが提供できる
<br>

### VPC
- AWS上に仮想ネットワーク作成できるサービス
- リージョンをまたがって作成不可、アベイラビリティゾーンにまたがって作成可能
- VPCの設計のポイント
  - プライベートIPアドレス範囲から指定する
    - VPCでは仮想のプライベートネットワーク空間を作成するので、プライベートIPアドレスの使用が推奨
    - 作成後は変更できないので、大きめに設定する
      - 大きさは /28 ~ /16。 /16が推奨
        | IPアドレス |
        | ---- |
        | 10.0.0.0 ~ 10.255.255.255 |
        | 172.16.0.0 ~ 172.31.255.255 |
        | 192.168.0.0 ~ 192.168.255.255 |
     - オンプレミスや他VPCのレンジと重複しないように気をつける
      - 相互接続する可能性がある場合は、重複しないように設計
<br>  

### サブネット
- VPCを細かく区切ったネットワーク
- パブリックサブネットやプライベートサブネットなど、ネットワークを区切るなどできる
- サブネットはアベイラビリティゾーンの中に作成する
- 複数のアベイラビリティゾーンにサーバーを構築することで、災害などに強くなる
- 冗長性を高めることがベストプラクティス
- サブネットの設計のポイント
  - 将来に必要なIPアドレス数を見積もって設定する
    - /24が標準的
  - サブネットの分割は、ルーティングとアベイラビリティゾーンを基準に行う
  - インターネットアクセスの有無、拠点アクセスの有無などのルーティングポリシーに応じて分割する
  - 高可用性のために、2つ以上のアベイラビリティゾーンを使用する

### ルーティング
- ネットワーク上でデータを転送する際、その経路を導き出すこと
- 送信先とターゲットによるネットワークの経路設定。
- VPC内通信のみ許可、インターネット通信許可といった設定が可能
- インターネットゲートウェイ
  - VPCとインターネットをつなげる仮想ルーター
- ルートテーブル
  - ルーターが管理しているルーティングの情報を集めたもの
  - どのIPがどのデバイスに紐づいているのか、どのネットワークに所属しているのかを管理

### Security groupとは
- VPC内でAmazon EC2（仮想サーバー）などのリソースに適用できる仮想ファイアウォール機能
<br>

### EC2 (Elastic Compute Cloud)
- AWSクラウド上の仮想サーバー
- インスタンスというのはEC2から立てられたサーバのこと
- 特徴
  - 数分で起動。
  - サーバーの追加・削除、マシンスペックの変更も可能
  - OSより上のレイヤについては自由に設定できる
- 重要概念
  - AMI
    - インスタンス起動に必要な情報が入ったOSのイメージ
    - サーバーのテンプレートのようなもの
  - インスタンスタイプ
    - サーバーのスペックを定義したもの。
    - インスタンスタイプにより、CPU、メモリ、ストレージ、ネットワーク帯域が異なる
  - ストレージ
    - サーバーにくっつけるデータの保存場所。EBSを使用することが多い
<br>

### SSH(Secure Shell)とは
- サーバーと自分の目の前のパソコンをセキュアにつなぐサービスのこと
- 通信内容が暗号化された遠隔ログインシステム
- ログインする側：SSHクライアント
- ログインされる側：SSHサーバー
- データを暗号化されたうえで、サーバーにログインできる
- 接続コマンド
  ```sh
  $ ssh -i {秘密鍵ファイル}.pem ec2-user@{パブリックIPアドレス}
  ```
<br>

#### 公開鍵認証
- EC2ではSSHログイン時に**公開鍵認証**を行っている
- サーバーへのログイン時に認証を行う仕組み
- ユーザー名とパスワードを使用した認証と比べ、よりセキュリティが高い
- 公開鍵暗号(秘密鍵と公開鍵)を用いて認証を行う
- 公開鍵はサーバーが保有。秘密鍵を持っているユーザーだけログイン可能
<br>

#### ポート番号について
- **プログラムのアドレス**
- 同一コンピューター内で通信を行うプログラムのを識別する時に利用される
  - SSH：22
  - HTTP : 80
  - HTTPS : 443
  - SMTP : 25
- ポート番号はどうやって決めるのか？
  - 標準で決められている番号
    - 代表的なプログラムが使うポート番号はあらかじめ決められている
    - welknown番号と呼ばれ、0~1023までのいずれかの整数値
    - 接続元が接続先のポート番号を省略したときは、このwelknown番号が利用される
  - 動的に決まる番号
    - サービスを提供する側はポート番号が決まっている必要があるが、接続元のポート番号は決まっていなくてもいい
    - クライアントのポート番号は、OSが他のポート番号と被らないように、ランダムに決める
    - 動的に割り当てる番号は49142~65535までのいずれかの整数値
- ポート番号の確認コマンド
  ```sh
  $ sudo lsof -i -n -P
  ```
<br>

#### Apache
- 全世界的に普及しているWebサーバのソフト
- コンピュータをWebサーバとしてのお仕事ができるコンピュータにするソフト
- Apacheをインストール
    ```sh
    $ sudo yum update -y
    # Apacheをインストール
    $ sudo yum -y install httpd
    # Apacheを起動
    $ sudo systemctl start httpd.service
    # 実行中のプロセス(httpd)を表示する
    $ ps -axu | grep httpd
    ```
    `sudo` : root権限で実行する
    `yum` : Linuxのパッケージ管理ツール
    `httpd` : apacheを構成する
    `ps` : プロセスを表示する
    `ax` : すべてのプロセス
    `x` : CPUやメモリ使用率を表示
    `grep` : 検索して表示するコマンド
<br>

#### ファイアウォール
- ネットワークを不正アクセスから守るために、
「通して良い通信だけを通して、それ以外は通さない」機能の総称
- AWSでは、セキュリティグループがファイアウォールの役割を担っている
<br>

#### Elastic IPアドレス
- EC2インスタンスのパブリックIPは、起動・停止すると別のIPアドレスが割り当てられる
- Elastic IPアドレスを使用すると、IPアドレスを固定できる
- インタネット経由でアクセス可能な固定グローバルIPアドレスを取得でき、
インスタンスに付与できるサービス
- インスタンスを削除するまでは、そのIPアドレスを使用可能
- Elastic IPアドレスは、EC2インスタンスに関連付けられ、インスタンスが起動中であれば無料
<br>

### RDSとは
- フルマネージドなリレーショナルデータベースのサービス
  - 構築から運用までAWSがやってくれる
  - 構築や運用の手間の低減
  - AWSエンジニアによるデータベース設計のベストプラクティスを適用
  - コア機能の開発に注力できる
  - 特徴
    - 高い可用性/パフォーマンスの向上/運用負荷の低減
  - 利用可能なエンジン
    - MySQL/PostgreSQL/Oracle/Microsoft SQL Server/Amazon Aurora/MariaDB
<br>

### TCP/IP
- インタネット通信を実現しているのがTCP/IPプロトコル
#### プロトコルとは？
- コンピュータ同士がネットワークを利用して通信するために決められた約束ごと
- なぜプロトコルは必要なのか
  - メーカーやOSが違うコンピュータ同士が通信するために、同じ仕様でやりとりする必要がある
  - そのためにプロトコルがあり、同じプロトコルを使用するという同意があるからこそ、
  様々なコンピュータ同士が通信できている
#### TCP/IPとは？
- TCP・IPを中心として、インタネットを構築する上で必要なプロトコル郡の総称
- インターネットを運用するために開発された
  - TCP/IPプロトコル郡
    - アプリケーションプロトコル：HTTP, SMTP, FTP
    - トランスポートプロトコル：TCP, UDP
    - 経路制御プロトコル：RIP, OSPF, BGP
    - インターネットプロトコル；IP, ICMP, ARP
##### TCP/IPの階層モデル
- インターネットでコンピュータ同士が通信する一連の処理を、4段階で表現したもの
- 通信に必要な機能全体を整理している
    | 層 | 役割 | プロトコル例 |
    | :----: | ---- | ---- |
    | アプリケーション層 | アプリケーション同士が会話する | HTTP, DNS, SSH, SMTP |
    | トランスポート層 | データの転送を制御する | TCP, UDP |
    | ネットワーク層 | IPアドレスを管理し、経路選択する | IP, UCMP, ARP |
    | ネットワーク<br>インターフェース層 | 直接接続された機器同士で通信する | Ethernet, PPP |
#### HTTP
- HyperText Transfer Protocol
- インターネットでHTMなどのコンテンツの送受信に用いられる通信の約束ごと
- クライアントがHTTPリクエストを送り、それに対してサーバーがHTTPレスポンスを返す
そのリクエスト・レスポンスの書き方がHTTPの招待
##### HTTPリクエストの中身
- リクエストライン
  - GET / HTTP/1.1
- ヘッダー
  - Host: exsample.com
  - User-Agent: Mozilla/5.0
  - Accept-Encoding: gzip, deflate
  - Connection: keep-alive
- ボディ
  - 特になし (オプション)
##### HTTPレスポンスの中身
- ステータスライン: HTTP/1.1 200 OK
- ヘッダー
  - Date: Fri, 28 Jun 2019 01:09:23 GMT
  - Content-Type: text/html: charset=UTF-8
  - Cache-Control: max-age=604800
  - Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
- ボディ
  ```html
    <!doctype html>
    <html>
    ...
    </html>
    ```
#### トランスポート層のプロトコル
- 代表的なプロトコルがTCPとUDP。通信の特性により使い分ける
- TCP
  - Transmission Control Protocol
  - 信頼性のある通信を提供
  - 信頼性を保つために、送信するパケットの順序制御や再送制御を行う
  - 信頼性のある通信を実現する必要がある場合に使用する
- UDP
  - User Datagram Protocol
  - 信頼性のない通信
  - 送信するだけで、パケットが届いたかは保証しない
  - 高速性やリアルタイム性を重視する通信で使用
##### UDP
- コネクションレスな通信サービス
- 特徴
  - アプリケーションから送信要求のあったデータをそのままネットワークに流す
  - パケットが届かなくても再送制御はしない
  - パケットの到着順序が入れ替わっても直せない
  - コネクションレスなのでいつでもデータを送信できる
  - プロトコルの処理も簡単なので高速
- 向いている用途
  - 動画や電話など、即時性が必要な通信
  - 総パケット数が少ない通信 (DNSなど)
  - 特定ネットワークに限定しtアプリケーションの通信
##### TCP
- 通信を制御するプロトコル。データの到達確認やコネクション管理を行う
- データの到達確認
  - 送信したデータが届いたかを確認する
  - 届いていなければ再送する
  - 確認応答とシーケンス番号を使用することで、再送制御などを行う
  - 8bit(一億テッド)ごとにシーケンス番号をつけて送信する
- コネクション管理
  - 通信相手との間で通信を始める準備をしてから通信を行う
  - コネクション指向の通信を提供する
### IP
#### IPの役割
- IPアドレス、終点コンピュータまでのパケット配送 (ルーティング)、パケットの分割・再構築処理
  - IPアドレス
    - ネットワーク上で、通信を行う宛先を識別するのに使われる
    - IPアドレスを元にしてパケットが配送される
  - ルーティング
    - 宛先IPアドレスのコンピュータまでパケットを届ける役割
    - それぞれの区間ごとにルータがIPパケットを転送し、それを繰り返して最終的な宛先コンピュータまでパケットがたどり着く
  - パケットの分割・再構築処理
    - ネットワークインターフェース層のプロトコルによって、最大転送単位が異なる
    - IPでは、各ネットワークインターフェースの最大転送単位より小さくなるようにパケットを分割して送信し、終点コンピュータで再構築する
<br>

### NAT (Network Address Translation)
- IPアドレスを変換する装置で、2つのインターフェースを持つ
- 一般的には、片側のインターフェースには「パブリックIPアドレス」を設定し、インターネットに接続可能な構成にし、
- もう片側のインターフェースには、「プライベートIPアドレス」を設定して、プライベートサブネットに接続するようにする
- これにより、プライベートサブネットからインターネットの向きだけの通信を許可できる
- NATを使うと、プライベートサブネットにインターネットから接続される危険性を排除しつつ、プライベートサブネット内でインターネットからライブラリなどを取得することができる
<br>

#### NATゲートウェイ
- インターネットから接続可能なパブリックサブネットにNATゲートウェイを配置し、プライベートサブネットからインターネット宛のパケットがNATゲートウェイを経由するようにルートテーブルを設定する

### AWS Cloud9
- Webブラウザ上でコードを実装できる、統合開発環境

## 踏み台サーバ経由でパブリックサブネットのEC2にSSH接続
### プライベートサブネットの踏み台サーバにSSH接続
```bash
$ ssh -i {秘密鍵ファイル}.pem ec2-user@{パブリックIPアドレス}
```
### 管理者権限で、プライベートサブネットにSSH接続
```bash
$ sudo chmod 400 {秘密鍵ファイル}.pem
$ sudo ssh -i {秘密鍵ファイル}.pem ec2-user@{プライベートIPアドレス}
```
